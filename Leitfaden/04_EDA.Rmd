---
editor_options: 
  markdown: 
    wrap: sentence
---

```{r, include=FALSE}
# Preliminaries
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(maps)
# library(countrycode)
library(leaflet)
#library(geojsonio)
library(viridis)
library(magick) # for including a .png in plots
TA_logo <- image_read("plot/TA_logo.png")
# library(gghighlight)
library(GGally)
library(ggrepel)
```

\newpage

# Exploratory Data Analysis

Before you can dive into the data, set up your programming environment.
This will be the place where the magic happens - all your coding takes place there.

::: {.tips .r data-latex="r"}
In your workspace on [RStudio Cloud](https://rstudio.cloud/projects), we have already uploaded an "assignment" for you (Template HoneyAndBees).
When you create a new project within the workspace *Class of '22 \| TechAcademy \| Data Science with R*, your workspace will open up.

We've already made some arrangements for you: The data sets you will be working with throughout the project are already available in your working directory.
We also created an RMarkdown file (a file that ends with `.Rmd` extension), with which you will be able to create a detailed report of your project.
You can convert that file into an HTML document when you have finished coding the project in R.
Open the file `Markdown_HoneyAndBees.Rmd` and see for yourself!
:::

::: {.tipsp .python data-latex="p"}
We recommend using [Google Colab](https://colab.research.google.com) for this project since it requires no particular setup, stores its notebooks to your Google Drive, and makes it easy for you to share them with your team members.

As an alternative to Google Colab, you might want to install Jupyter Notebook locally using the Anaconda distribution.
We will give you a more detailed step-by-step demo during the first coding meetup.
:::

Next up is importing the data sets. It's best to this **once** on the top
level of your notebook / script. You can always copy to new variables and work on slices of the data frames afterwards.

* [Honey](https://drive.google.com/uc?export=download&id=1bQtWQluwwGUIgZuDOsJOE-4Om7x4HOxP)
* [Bees](https://drive.google.com/uc?export=download&id=1lop3qnrSve5A13jNcL6wCehGpDaCrGRO)
* [Weather](https://drive.google.com/uc?export=download&id=1N78o7a8l2v9O9T3rurGfyEBAZEAOTG2h)



## Exploring Honey and Bees Data

### Discovering the Data
Let's start by looking at the bee & honey data sets. 

* Have a look at the frequency of the records (is there a difference across sets?)
* Do you see any missing values or data entries that are different from the other entries?
* What are the data formats (e.g. data types like strings or floats but also date formats such as yearly)? 
* Look at the unit of every variable, can you make sense of the units?

Write down a couple of sentences to these questions, the goal is to show your readers what you are seeing. Also, comment on any errors or irregularities which you notice and that could be an issue later on in the project. What irregularities you ask? Look at the missing values, logical expressions, numbers, variables types, etc.
But do not worry, there is no right or wrong here!

::: {.tips .r data-latex="r"}
You can import all data files directly from your working directory by, for examples, using the command `bees <- read_csv("bees.csv")`. 
Use `head()`, `str()`, or `class()` to get an overview.

If you need some additional, more general information on how to import data and different data types, check out this [cheat sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-import.pdf).
:::

::: {.tipsp .python data-latex="p"}
You can feed the links to the respective data files above to a method of the 
[pandas package](https://pandas.pydata.org/pandas-docs/stable/reference/io.html) (you might want to specify the index column).
Check out the resulting `pd.DataFrame` instance with the `head()` method and 
the `dtpyes` attribute. You can also dig into a specific column with `describe()`.
Here's an additional [pandas cheat sheet](https://pandas.pydata.org/Pandas_Cheat_Sheet.pdf) for you to reference 
:::


### Give some overall statements 

Now that you have imported all data sets, lets get into the details of the **honey data**. Since you have already got a feeling by now, it would be interesting to indicate some outstanding features of the set: 

* Which state had the most producing colonies ever and in which year? Anything special about that state?
* What state had the lowest price for honey. How low was it?
* What is the total Honey production for 2016?


## Data Cleaning and Useful Transformations

The exercises in this and the next section are about the **bees data** set.
In the later stages of the project, we would like to merge the bee data set with the honey data set. To this end, we will now spend some time preparing the bees data set.

### Date Formatting

From exploring the data in the previous tasks you might have notice the differences in frequency of the data. The date (format) of the bees set is quarterly, whereas we have yearly honey data. 
Recall also that dates, even just years, can be formatted differently than just as a string or integer. Maybe you have checked it before, but now is definitely the moment to translate the `Date` column to a fitting date format. 

::: {.tips .r data-latex="r"}
You can use the lubridate package to transform "years" into a date format. To things easier, check out the [lubridate package cheat sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/lubridate.pdf).
If you would like to read up on some general information on date formats with R in your spare time, have a look [here](https://www.r-bloggers.com/2013/08/date-formats-in-r/)
:::

::: {.tipsp .python data-latex="p"}
`pd.to_datetime()` is what I would look at for example.
A corresponding DataCamp resource is section 4 in [Working with dates and times in Python](https://app.datacamp.com/learn/courses/working-with-dates-and-times-in-python).
Also, the [Data Manipulation with pandas](https://app.datacamp.com/learn/courses/data-manipulation-with-pandas) course is of great help for the following exercises.
:::


### More Data Types

So far you converted years into a more appropriate date format for further investigation. 
Have a look at the other columns of the bees data set: Some appear to contain numbers, but are they also of a numeric data type? Check out all columns so you don't miss out on one!

For further calculations, it is safer to convert these columns to a numeric data type.
While there are vectorized methods that can convert data types at once, we would like you to write a (really) simple 'for' loop to conduct the conversions.

::: {.tips .r data-latex="r"}
Have you heard of "sapply"? This might help you. We recommend you to check out the documentation, which you can access by typing `help("sapply")` into the console, or by browsing the web. Remember, you want to convert multiple columns into the numeric format, so be careful to select all the columns!
:::

::: {.tipsp .python data-latex="p"}
You need an iterable to loop over, the semicolon after the keyword, and the indentation of the subsequent lines!
Here is a [cheat sheet](https://drive.google.com/file/d/15DwPt5r_vySfuWdOAvci71bDSnD7533P/view?usp=sharing) in case you have forgotten.
:::

### Converting Units

From the column names you can see that the honey data set is in pounds as we are dealing with an U.S. data set. 
However, we are devoted followers of the metric system and do not understand pounds. Consequently, we would like to translate them to kilogram [kg].
While you are at it, you might want to give your new columns in kg a shorter name with less spaces in it. For example "Honey producing colonies (thousand) " could be named "producing_colonies_thousand".


### Rounding

Have a look at your column values. Some columns have long decimal numbers. To simplify your data frame, round up to the decimal place you prefer.
Please write one or two sentences why you think rounding is O.K. and why you chose the decimal place *X* or even a conversion to integer.


## Simple Metrics

### Missing Values
Look at the bees set and its missing values. Decide on how you want to treat them and give us a detailed explanation why you have decided to treat the missing values the way you did. Keep in mind that these transformations affect all your subsequent work on the data and may bias your findings. 
Sometimes you are lucky and can also identify a pattern that will ease your pain of treating the values and deciding for a strategy.

There are many possibilities: From excluding the rows to forward / backward fills or even inserting an average / median. 

::: {.tips .r data-latex="r"}
We highly recommend the [Datacamp course on missing values in R](https://www.datacamp.com/courses/dealing-with-missing-data-in-r) for this exercise.
:::

::: {.tipsp .python data-latex="p"}
We highly recommend the [Datacamp course on missing values in Python](https://www.datacamp.com/courses/dealing-with-missing-data-in-python) for this exercise.
:::


### Lost Colonies

Add a new column where you add the percentage of lost colonies in reference to the maximum colonies (it is as simple as it reads). 


### Group Means

We want to merge the honey and bees data set to analyze them jointly. To do so we need to reduce the frequency of the bees data frame (quarterly) to yearly, so you only have data for 2015, 2016, 2017, 2018, 2019, and 2020 per state left.
Accordingly, you would like to group by state and quarter and replace the observations by an aggregate.

You decide to replace with the mean (over the four quarters). Please mind how you are rounding, print the table of your aggregated data frame, and answer the following two questions

* What are potential hazards of reducing data like this? 
* What other measures could you use?

You may refer to the following graph.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center", out.width = "100%"}
knitr::include_graphics("plot/Lost Colonies in Wyoming over time.jpg")
```

There is no absolute answer to these questions since your approach most likely depends on what you are analyzing / trying to show or understand.


::: {.tips .r data-latex="r"}
An approach with dyplr is the cleanest in this case. Use mutate, group_by, select and summarize. In the summarize call you can add multiple functions together. 
:::

::: {.tipsp .python data-latex="p"}
With two-dimensional (panel) data your `.groupby` statement on the data frame should consider both index values and the time dimension.
The resulting `GroupBy` object supports various aggregation methods out-of-the-box.
:::


## Merging Data Sets

When preparing to data sets, it is wise to check the naming of columns again.
Please give your "bees" data columns appropriate names (we recommend names where empty spaces are replaced with an underscore "_"), if you have not done so for the honey data set please do the same.

::: {.tips .r data-latex="r"}
Column names can be adjusted with tidyselect's "rename" function.
:::

::: {.tipsp .python data-latex="p"}
Column names can be replaced very neatly by passing a dictionary `{"x": "y", }` to a certain pandas method.
:::

### Joint Honey and Bees Set {#Merging}

Do an inner merge of the two sets by exploiting the index / State names and the respective date columns. 
Closely compare the sizes of the individual data frames and of the aggregate one. 

* Do they match (*hint: they do not*)?
* Why not and what states are missing from which individual data frame?

::: {.tips .r data-latex="r"}
Check out the R base [merge function](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/merge) documentation.
:::

::: {.tipsp .python data-latex="p"}
Check out the pandas [merge function](https://pandas.pydata.org/docs/reference/api/pandas.merge.html) documentation.
If it helps you, visualize what the identifiers in each table are and how they relate to each other. 
The DataCamp course [Joining Data with pandas (4h)](https://app.datacamp.com/learn/courses/joining-data-with-pandas) might also get you started.
:::

## States Bar Plot
Use the aggregate (yearly) set and create a bar plot with all states plotting starting bee colonies from the lowest to the highest value.
Please also include the average and the median of the observations. 

You can decide for yourself whether you want to aggregate over all years or over a single year of your choice.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center", out.width = "100%"}
knitr::include_graphics("plot/Starting Colonies in 2020.jpg")
```

::: {.tips .r data-latex="r"}
The key commands that you can use for this within ggplot() are geom_bar() and coord_flip(). Check back on the [ggplot2 cheat sheet](https://www.maths.usyd.edu.au/u/UG/SM/STAT3022/r/current/Misc/data-visualization-2.1.pdf) if you are feeling unsure! Also, you might want to store the median and mean  seperatly and refer to them in your ggplot call. 
:::

::: {.tipsp .python data-latex="p"}
In case you want to filter a certain year check out [`.loc` indexing](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.loc.html).
Afterwards you are looking for [matplotlib's horizontal bar plot](https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.barh.html). Should you get stuck adding the lines to the plot, you can look at the following [stackoverflow question](https://stackoverflow.com/questions/33382619/plot-a-horizontal-line-using-matplotlib).
Oftentimes, when you want to create plots that are a little bit more elaborate, you will find an initial statement like this:

    # import statement on top, of course
    from matplotlib import pyplot as plt
    fig, ax = plt.subplots()

The trick is to add to the generated `Figure` and `Axes` object subsequently.
For further resources the course [Introduction to Data Visualization with Matplotlib (4h)](https://app.datacamp.com/learn/courses/introduction-to-data-visualization-with-matplotlib) is a good place to start!
:::


## Splitting the Data Set

Let's do some individual work, that can be compared wihtin in your group in the end. To do so, split a subset for data between the your team members. You should have 40 States in your merged dataset, so in a group with 4 team members, each of you would be looking at 10 states.

::: {.tips .r data-latex="r"}
the code: dataset$Group <- c(rep(1,60),rep(2,60), rep(3,60), rep(4, 60)) could help if you are 4 team members. If not, this code might be easy to adjust.
:::

::: {.tipsp .python data-latex="p"}
Make sure to sort your state index first, afterwards make use of `numpy's` `array_split(df, x)` function (it never hurts to make a sanity check/print afterwards).
:::

### Yearly Boxplots

Next, let's visualize the split data with beautiful Boxplots. Generate 4 Boxplot aggregated for each year.  They should look at Honey Production, Parasite: Varroa Mite, Precipitation, and Lost Bee Colonies. 
In the end you can compare your 4 Boxplots with the ones your team members created. Keep in mind to communicate the same scaling, otherwise a visual comparison will not work out.
**Tip:** It will be 6 boxes for each Boxplot since we look at 6 years, as shown in the example.

Note that applying the logarithm to the colony values is a very useful thing to do. With this transformation you achieve a reasonable visualization without excluding a state since we have a strong outlier in California. To convince yourself, you can easily plot both Boxplots (with and without log) of maximum colonies for example.

Also, applying the log "normalizes" the distribution of values (frequently seen in empirical statistics) assuming that the underlying values approximately follow a log-normal distribution.
A very superficial take on this can be found [here (5 min read)](https://medium.com/@kyawsawhtoon/log-transformation-purpose-and-interpretation-9444b4b049c9).

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
knitr::include_graphics("plot/Log Honey Production.jpg")
knitr::include_graphics("plot/Varroa Mites.jpg")
```
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
knitr::include_graphics("plot/Log Lost Bee Colonies.jpg")
knitr::include_graphics("plot/Average Precipitation.jpg")
```


::: {.tips .r data-latex="r"}
Again, ggplot() and this time geom_boxplot() will help you visualizing.
:::

::: {.tipsp .python data-latex="p"}
Surprise, you are looking for the `.boxplot(...)` function!
:::


## Visualization with Maps
Last but not least, we want to do a more appealing visualization.
The idea is to combine the geographic information on the states with the numeric data to provide a rich visual that reflects the two aspects.

### Geographic Map with State Pop-ups 
We start by exploiting the coordinates provided with the data and our joint honey and bees set to obtain a responsive map of the U.S.A.

The map should reflect information about some key variables like the maximum- and lost colonies as well as the honey production and stock price in a year of your choice.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center", out.width = "100%"}
knitr::include_graphics("plot/Map_with_Popups.png")
```

::: {.tips .r data-latex="r"}
This time, we created the plot using the leaflet package. Why don’t you try to find information on the package online?

You can create a basic map with leaflet and add additional layers by following these simple steps:

m <- leaflet() %>%
  addTiles() %>% 
  addMarkers(lng= , 
             lat= , 
             popup= )
           
Do lng and lat look familiar to you from a previous plot?

The popup is where the magic happens! Can you make the map show you honey production, number of bee colonies, and three more variables that you find important for such a plot?
:::

::: {.tipsp .python data-latex="p"}
We are going to use yet another library, this one is called `folium`.

For this task you need to work with its documentation which you can find online.

Use folium’s Circle (Marker) to draw a circle for each state at its centered coordinates (latitude, longitude). You will need to implement a for-loop to iterate over all states. 
    
    import folium
    # Initiate the map
    m = folium.Map(
        location=[39, -101],  # Somewhat central U.S.A
        zoom_start=3.5,
        tiles='Stamen Terrain'  # one of many Map Styles
    )
    
    # Use a for-loop to plot circles
    for idx, row in df.iterrows() :
        # Your code here
    
    m  # Displays the map


:::

### Animating Changes over Time
Since we have looked at a single year in the plot before (with multiple variables), we would like to mix things up and look at transitions here.
In this case we plot a heat map showing the transition of log starting colonies over time for each state creating a very dynamic plot.

Note again the log transformation for visualization purposes. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center", out.width = "100%"}
knitr::include_graphics("plot/States_map_bee_starting_pop.gif")
```

::: {.tips .r data-latex="r"}
Add tip
:::

::: {.tipsp .python data-latex="p"}
There is a really cool utility built-in to [plotly express](https://plotly.com/python/choropleth-maps/) so you do not have to specify the tedious coordinates for your plots.
In fact, the animation above is essentially one single function call.

For animation, the `choropleth` function takes an *animation_frame* and *animation_group* argument which you need to specify explicitly besides your data frame. 
:::

## Surprise Us! 
You discovered anything cool and / or want to experiment with a new visualization technique to the deliver the message?
Here is the right place to put down anything you did and would like to do with the project that did not quite fit in the other exercise sections.

**Congratulations**! Based on your work with fundamental data transformations and many visualizations, you now have a solid understanding of the honey and bees data sets!
With this, you have completed the *EDA* part of the project!
